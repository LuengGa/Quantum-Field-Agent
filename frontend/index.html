<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Quantum Field Agent</title>
<style>
:root {
  --bg: #050508;
  --bg2: #0a0a12;
  --bg3: #12121c;
  --border: rgba(0,255,136,0.08);
  --text: #e0e0e0;
  --text2: #888;
  --accent: #00ff88;
  --accent2: #00aaff;
  --accent3: #ff66aa;
}

[data-theme="light"] {
  --bg: #f5f5f7;
  --bg2: #ffffff;
  --bg3: #f0f0f2;
  --border: rgba(0,150,100,0.15);
  --text: #1d1d1f;
  --text2: #6e6e73;
  --accent: #00a855;
  --accent2: #007aff;
  --accent3: #ff2d55;
}

* { margin: 0; padding: 0; box-sizing: border-box; }
html, body { height: 100%; overflow: hidden; }
body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; display: flex; height: 100vh; }

.sidebar { width: 280px; background: var(--bg3); border-right: 1px solid var(--border); display: flex; flex-direction: column; transform: translateX(-100%); transition: transform 0.3s; position: fixed; left: 0; top: 0; bottom: 0; z-index: 1000; }
.sidebar.open { transform: translateX(0); }
.sidebar-header { padding: 16px; border-bottom: 1px solid var(--border); }
.sidebar-title { font-size: 13px; font-weight: 600; color: var(--accent); letter-spacing: 1px; }
.new-chat-btn { width: 100%; margin-top: 12px; padding: 12px; background: linear-gradient(135deg, var(--accent), #00cc6a); color: #000; border: none; border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; }
.session-list { flex: 1; overflow-y: auto; padding: 12px; }

.main { flex: 1; display: flex; flex-direction: column; height: 100%; position: relative; z-index: 1; }
.header { padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--bg2); display: flex; justify-content: space-between; align-items: center; }
.menu-btn { background: none; border: 1px solid var(--border); color: var(--accent); font-size: 18px; width: 40px; height: 40px; border-radius: 10px; cursor: pointer; }
.title { font-size: 16px; font-weight: bold; background: linear-gradient(90deg, var(--accent), #00d4aa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

.status-indicator { display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(0,0,0,0.3); border-radius: 20px; border: 1px solid var(--border); }
[data-theme="light"] .status-indicator { background: rgba(0,0,0,0.05); }
.status-dot { width: 8px; height: 8px; border-radius: 50%; background: #333; }
.status-dot.ready { background: var(--accent); box-shadow: 0 0 10px rgba(0,255,136,0.4); }
.status-dot.resonance { background: var(--accent2); animation: pulse 0.5s infinite; }
.status-dot.processing { background: var(--accent); animation: pulse 0.6s infinite; }
.status-dot.collapse { background: var(--accent3); animation: pulse 0.4s infinite; }
@keyframes pulse { 0%,100% { transform: scale(1); } 50% { transform: scale(1.4); } }
.status-text { font-size: 11px; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }

.theme-btn { background: none; border: 1px solid var(--border); color: var(--text2); font-size: 16px; width: 36px; height: 36px; border-radius: 50%; cursor: pointer; }

.domain-selector { display: flex; gap: 6px; padding: 10px 16px; background: var(--bg3); border-bottom: 1px solid var(--border); overflow-x: auto; }
.domain-btn { padding: 6px 14px; background: transparent; border: 1px solid var(--border); color: var(--text2); border-radius: 16px; font-size: 12px; cursor: pointer; }
.domain-btn.active { background: rgba(0,255,136,0.08); border-color: var(--accent); color: var(--accent); }

.field-viz { display: flex; align-items: center; gap: 8px; padding: 10px 16px; background: var(--bg2); border-bottom: 1px solid var(--border); overflow-x: auto; }
.field-label { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 1px; writing-mode: vertical-rl; }
.skill-node { padding: 6px 14px; background: var(--bg3); border: 1px solid var(--border); border-radius: 18px; font-size: 11px; color: #555; white-space: nowrap; transition: all 0.3s; }
.skill-node.active { border-color: var(--accent); color: var(--accent); background: rgba(0,255,136,0.08); box-shadow: 0 0 30px rgba(0,255,136,0.4); animation: skillPulse 1s ease; }
.skill-node.resonating { border-color: var(--accent2); color: var(--accent2); background: rgba(0,170,255,0.08); animation: skillResonate 0.8s ease; }
@keyframes skillPulse { 0% { transform: scale(1); box-shadow: 0 0 0 rgba(0,255,136,0); } 40% { transform: scale(1.2); box-shadow: 0 0 50px rgba(0,255,136,0.6); } 100% { transform: scale(1); box-shadow: 0 0 30px rgba(0,255,136,0.4); } }
@keyframes skillResonate { 0% { transform: scale(1); } 30% { transform: scale(1.3); box-shadow: 0 0 30px rgba(0,170,255,0.6); } 100% { transform: scale(1); } }

.chat { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 12px; }
.message { max-width: 85%; padding: 12px 16px; border-radius: 12px; line-height: 1.6; font-size: 14px; animation: fadeIn 0.4s ease; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

/* å…³é”®ä¿®å¤ï¼šä½¿ç”¨CSSå˜é‡ç¡®ä¿ä¸»é¢˜åˆ‡æ¢æ­£å¸¸å·¥ä½œ */
.message.user { 
  align-self: flex-end; 
  background: rgba(35,35,50,0.95); 
  border: 1px solid var(--border); 
  color: var(--text); 
  border-bottom-right-radius: 4px; 
}
.message.ai { 
  align-self: flex-start; 
  background: rgba(0,255,136,0.05); 
  border: 1px solid rgba(0,255,136,0.2); 
  color: var(--text); 
  border-bottom-left-radius: 4px; 
}

/* äº®è‰²ä¸»é¢˜ä¸‹ä¿®å¤ */
[data-theme="light"] .message.user { background: rgba(240,240,245,0.98); }
[data-theme="light"] .message.ai { background: rgba(0,168,85,0.08); border-color: rgba(0,168,85,0.3); }

.message-label { font-size: 10px; opacity: 0.5; margin-bottom: 6px; }
.stage-timeline { margin-top: 10px; padding-top: 10px; border-top: 1px solid var(--border); }
.stage-item { display: flex; align-items: center; gap: 6px; margin: 4px 0; font-size: 11px; color: var(--text2); animation: stageIn 0.5s ease; }
@keyframes stageIn { from { opacity: 0; transform: translateX(-10px); } to { opacity: 1; transform: translateX(0); } }

/* ========== æ”¹è¿›çš„é˜¶æ®µåŠ¨ç”»æ ·å¼ ========== */
.stage-item {
    display: flex;
    align-items: center;
    gap: 8px;
    margin: 6px 0;
    padding: 6px 10px;
    font-size: 12px;
    border-left: 3px solid transparent;
    border-radius: 0 8px 8px 0;
    background: linear-gradient(90deg, transparent, transparent);
    transition: all 0.3s ease;
}

.stage-item.stage-resonance {
    border-left-color: var(--accent2);
    background: linear-gradient(90deg, rgba(0,170,255,0.1), transparent);
}

.stage-item.stage-interference {
    border-left-color: var(--accent);
    background: linear-gradient(90deg, rgba(0,255,136,0.1), transparent);
}

.stage-item.stage-collapse {
    border-left-color: var(--accent3);
    background: linear-gradient(90deg, rgba(255,102,170,0.1), transparent);
}

/* æ”¹è¿›çš„æŠ€èƒ½èŠ‚ç‚¹åŠ¨ç”» */
.skill-node.processing {
    border-color: var(--accent) !important;
    color: var(--accent) !important;
    background: rgba(0,255,136,0.15) !important;
    animation: skillProcessing 0.8s ease infinite !important;
}

@keyframes skillProcessing {
    0%, 100% { 
        transform: scale(1); 
        box-shadow: 0 0 0 rgba(0,255,136,0);
    }
    50% { 
        transform: scale(1.15); 
        box-shadow: 0 0 25px rgba(0,255,136,0.5);
    }
}

/* æ”¹è¿›çš„çŠ¶æ€æŒ‡ç¤ºå™¨ */
.status-dot.resonance {
    background: var(--accent2);
    box-shadow: 0 0 15px rgba(0,170,255,0.6);
    animation: statusPulse 0.5s ease infinite;
}

.status-dot.interference {
    background: var(--accent);
    box-shadow: 0 0 15px rgba(0,255,136,0.6);
    animation: statusPulse 0.7s ease infinite;
}

.status-dot.collapse {
    background: var(--accent3);
    box-shadow: 0 0 15px rgba(255,102,170,0.6);
    animation: statusPulse 0.4s ease infinite;
}

@keyframes statusPulse {
    0%, 100% { transform: scale(1); opacity: 1; }
    50% { transform: scale(1.4); opacity: 0.8; }
}

.input-area { padding: 12px 16px; background: var(--bg2); border-top: 1px solid var(--border); display: flex; gap: 10px; align-items: center; }
#msg-input { flex: 1; background: var(--bg3); border: 1px solid var(--border); color: var(--text); padding: 12px 18px; border-radius: 24px; font-size: 14px; outline: none; }
#msg-input:focus { border-color: var(--accent); box-shadow: 0 0 0 4px rgba(0,255,136,0.1); }
.send-btn { background: linear-gradient(135deg, var(--accent), #00cc6a); color: #000; border: none; padding: 12px 24px; border-radius: 24px; font-weight: 600; cursor: pointer; }
.send-btn:disabled { background: var(--bg3); color: var(--text2); cursor: not-allowed; }
</style>
</head>
<body data-theme="dark">

<div class="sidebar" id="sidebar">
  <div class="sidebar-header">
    <div style="display:flex;justify-content:space-between;align-items:center;">
      <span class="sidebar-title">ğŸ“š å¯¹è¯å†å²</span>
      <button onclick="toggleSidebar()" style="background:none;border:none;color:var(--text2);cursor:pointer;font-size:18px;">âœ•</button>
    </div>
    <button class="new-chat-btn" onclick="newChat()">+ æ–°å¯¹è¯</button>
  </div>
  <div class="session-list" id="session-list">
    <div style="padding:20px;text-align:center;color:var(--text2);font-size:13px;">æš‚æ— å¯¹è¯è®°å½•</div>
  </div>
</div>

<div class="main">
  <div class="header">
    <div class="header-left">
      <button class="menu-btn" onclick="toggleSidebar()">â˜°</button>
      <span class="title">âš› Quantum Field</span>
    </div>
    <div class="status-container">
      <div class="status-indicator">
        <div class="status-dot ready" id="status-dot"></div>
        <span class="status-text" id="status-text">å°±ç»ª</span>
      </div>
      <button class="theme-btn" onclick="toggleTheme()" title="åˆ‡æ¢ä¸»é¢˜">
        <span id="theme-icon">ğŸŒ™</span>
      </button>
    </div>
  </div>

  <div class="domain-selector">
    <button class="domain-btn active" data-domain="">é€šç”¨åœº</button>
    <button class="domain-btn" data-domain="life">ç”Ÿæ´»</button>
    <button class="domain-btn" data-domain="office">åŠå…¬</button>
    <button class="domain-btn" data-domain="math">è®¡ç®—</button>
  </div>

  <div class="field-viz">
    <span class="field-label">æŠ€èƒ½åœº</span>
    <div id="skill-field" style="display:flex;gap:8px;"></div>
  </div>

  <div class="chat" id="chat-container">
    <div class="message ai">
      <div class="message-label">âš› Quantum Field</div>
      æ¬¢è¿è¿›å…¥é‡å­åœºï¼åŸºäºé‡å­åœºæ¶æ„çš„æ™ºèƒ½åŠ©æ‰‹ã€‚<br><br>
      <strong>ä½¿ç”¨æ–¹æ³•ï¼š</strong><br>
      è¾“å…¥æ¶ˆæ¯ï¼Œè§‚å¯Ÿå…±æŒ¯â†’å¹²æ¶‰â†’åç¼©çš„åŠ¨æ€æ•ˆæœ
    </div>
  </div>

  <div class="input-area">
    <input type="text" id="msg-input" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰ Enter å‘é€..." autocomplete="off">
    <button class="send-btn" id="send-btn" onclick="sendMessage()">å‘é€</button>
  </div>
</div>

<script>
// è‡ªåŠ¨æ£€æµ‹ API åœ°å€
// å¦‚æœåœ¨åŒä¸€åŸŸåä¸‹ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼Œå¦åˆ™ä½¿ç”¨ç¯å¢ƒå˜é‡æˆ–é»˜è®¤ç«¯å£
const getAPIUrl = () => {
  // å°è¯•ä»å½“å‰åŸŸåæ¨æ–­
  const protocol = window.location.protocol;
  const hostname = window.location.hostname;

  // å¦‚æœæ˜¯ localhost æˆ– 127.0.0.1ï¼Œä½¿ç”¨é»˜è®¤ç«¯å£ 8000
  if (hostname === 'localhost' || hostname === '127.0.0.1') {
    return `${protocol}//${hostname}:8000`;
  }

  // å¦åˆ™ä½¿ç”¨ç›¸å¯¹è·¯å¾„ï¼ˆåŒæºï¼‰
  return '';
};

const API = getAPIUrl();
let curSession = null;
let curDomain = null;
const userId = 'user_' + Date.now();
let isSending = false;

// ä¸»é¢˜ç®¡ç†
function initTheme() {
  const saved = localStorage.getItem('theme') || 'dark';
  document.body.dataset.theme = saved;
  document.getElementById('theme-icon').textContent = saved === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
}

function toggleTheme() {
  const current = document.body.dataset.theme;
  const next = current === 'dark' ? 'light' : 'dark';
  document.body.dataset.theme = next;
  localStorage.setItem('theme', next);
  document.getElementById('theme-icon').textContent = next === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
}

// ä¾§è¾¹æ 
function toggleSidebar() {
  document.getElementById('sidebar').classList.toggle('open');
}

// çŠ¶æ€
function setStatus(state, text) {
  const dot = document.getElementById('status-dot');
  const label = document.getElementById('status-text');
  dot.className = 'status-dot ' + state;
  label.textContent = text;
}

// åŠ è½½æŠ€èƒ½
async function loadSkills() {
  try {
    const res = await fetch(API + '/skills');
    const data = await res.json();
    const container = document.getElementById('skill-field');
    container.innerHTML = '';
    data.skills.forEach(skill => {
      const node = document.createElement('div');
      node.className = 'skill-node';
      node.id = 'skill-' + skill.name;
      node.textContent = skill.name;
      container.appendChild(node);
    });
  } catch(e) {
    console.error('åŠ è½½æŠ€èƒ½å¤±è´¥:', e);
  }
}

// æ·»åŠ æ¶ˆæ¯
function addMessage(role, html) {
  const container = document.getElementById('chat-container');
  const div = document.createElement('div');
  div.className = 'message ' + role;
  div.innerHTML = '<div class="message-label">' + (role === 'user' ? 'You' : 'âš› Field') + '</div>' + html;
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

// æ·»åŠ é˜¶æ®µåŠ¨ç”»
function addStage(stage, skills, delay) {
  setTimeout(() => {
    const names = {
      resonance: { color: 'var(--accent2)', name: 'å…±æŒ¯', icon: 'â—' },
      interference: { color: 'var(--accent)', name: 'å¹²æ¶‰', icon: 'â‡Œ' },
      collapse: { color: 'var(--accent3)', name: 'åç¼©', icon: 'â—' }
    };
    const info = names[stage] || { color: '#888', name: stage, icon: 'â€¢' };
    
    let skillHtml = '';
    if (skills && skills.length > 0) {
      skillHtml = '<span style="color:' + info.color + ';margin-left:8px;">[' + skills.join(',') + ']</span>';
    }
    
    const item = document.createElement('div');
    item.className = 'stage-item';
    item.innerHTML = '<span style="color:' + info.color + '">' + info.icon + '</span><span style="color:' + info.color + ';font-weight:500;">' + info.name + '</span>' + skillHtml;
    
    const timeline = document.querySelector('.stage-timeline');
    if (timeline) timeline.appendChild(item);
    
    // æŠ€èƒ½èŠ‚ç‚¹åŠ¨ç”»
    if (skills) {
      skills.forEach(s => {
        const node = document.getElementById('skill-' + s);
        if (node) {
          node.classList.remove('active', 'resonating');
          void node.offsetWidth; // è§¦å‘é‡ç»˜
          if (stage === 'resonance') node.classList.add('resonating');
          else node.classList.add('active');
        }
      });
    }
    
    setStatus(stage, info.name);
  }, delay);
}

// ========== æ”¹è¿›çš„é˜¶æ®µåŠ¨ç”»å‡½æ•° ==========
function addStageEnhanced(stage, skills, metadata) {
  const names = {
    resonance: { 
      color: 'var(--accent2)', 
      name: 'å…±æŒ¯', 
      icon: 'â—',
      description: 'æŠ€èƒ½é€‰æ‹©ä¸­...'
    },
    interference: { 
      color: 'var(--accent)', 
      name: 'å¹²æ¶‰', 
      icon: 'â‡Œ',
      description: metadata.tools ? `å¤„ç† ${metadata.tools} ä¸ªå·¥å…·` : 'å¤„ç†ä¸­...'
    },
    collapse: { 
      color: 'var(--accent3)', 
      name: 'åç¼©', 
      icon: 'â—',
      description: skills.length > 0 ? `æ¿€æ´»: ${skills.join(', ')}` : 'ç”Ÿæˆå›å¤...'
    }
  };
  
  const info = names[stage] || { color: '#888', name: stage, icon: 'â€¢', description: '' };
  
  const timeline = document.querySelector('.stage-timeline');
  if (!timeline) return;
  
  // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒé˜¶æ®µ
  const existing = timeline.querySelector('.stage-' + stage);
  if (existing) return;
  
  // åˆ›å»ºé˜¶æ®µé¡¹
  const item = document.createElement('div');
  item.className = 'stage-item stage-' + stage;
  item.innerHTML = `
    <span style="color:${info.color};font-size:14px;">${info.icon}</span>
    <span style="color:${info.color};font-weight:600;">${info.name}</span>
    <span style="color:var(--text2);margin-left:8px;font-size:11px;">${info.description}</span>
  `;
  
  // æ·»åŠ æŠ€èƒ½æ ‡ç­¾
  if (skills.length > 0) {
    const skillsSpan = document.createElement('span');
    skillsSpan.style.cssText = 'margin-left:auto;display:flex;gap:4px;';
    skills.forEach((skill, index) => {
      const tag = document.createElement('span');
      tag.style.cssText = `
        background: ${info.color}20;
        color: ${info.color};
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 10px;
        border: 1px solid ${info.color}40;
      `;
      tag.textContent = skill;
      skillsSpan.appendChild(tag);
    });
    item.appendChild(skillsSpan);
  }
  
  timeline.appendChild(item);
  
  // ========== æ”¹è¿›çš„æŠ€èƒ½èŠ‚ç‚¹åŠ¨ç”» ==========
  if (skills.length > 0) {
    skills.forEach((skill, index) => {
      const node = document.getElementById('skill-' + skill);
      if (node) {
        // æ¸…é™¤ä¹‹å‰çš„çŠ¶æ€
        node.classList.remove('active', 'resonating', 'processing');
        void node.offsetWidth; // å¼ºåˆ¶é‡ç»˜
        
        // æ ¹æ®é˜¶æ®µæ·»åŠ ä¸åŒåŠ¨ç”»
        if (stage === 'resonance') {
          // å…±æŒ¯é˜¶æ®µï¼šè“è‰²è„‰å†²ï¼Œå¿«é€Ÿé—ªçƒ
          node.classList.add('resonating');
          node.style.animationDelay = (index * 0.1) + 's';
        } else if (stage === 'interference') {
          // å¹²æ¶‰é˜¶æ®µï¼šç»¿è‰²è„‰å†²ï¼Œè¡¨ç¤ºå¤„ç†ä¸­
          node.classList.add('processing');
        } else if (stage === 'collapse') {
          // åç¼©é˜¶æ®µï¼šç¨³å®šé«˜äº®
          node.classList.add('active');
        }
      }
    });
  }
  
  // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
  setStatus(stage, info.name);
}

// ========== å†…å®¹æ ¼å¼åŒ–å‡½æ•° ==========
function formatContent(text) {
  return text
    .replace(/\n/g, '<br>')
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code style="background:rgba(0,255,136,0.1);padding:2px 6px;border-radius:4px;font-family:monospace;">$1</code>');
}

// ========== æ”¹è¿›çš„å‘é€æ¶ˆæ¯å‡½æ•° ==========
async function sendMessage() {
  const input = document.getElementById('msg-input');
  const btn = document.getElementById('send-btn');
  const msg = input.value.trim();
  
  if (!msg || isSending) return;
  
  isSending = true;
  input.value = '';
  btn.disabled = true;
  
  // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
  addMessage('user', msg);
  
  // æ¸…é™¤ä¹‹å‰çš„æŠ€èƒ½çŠ¶æ€
  document.querySelectorAll('.skill-node').forEach(n => {
    n.classList.remove('active', 'resonating', 'processing');
    n.style.animationDelay = '';
  });
  
  try {
    const res = await fetch(API + '/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        message: msg,
        user_id: userId,
        session_id: curSession,
        domain_focus: curDomain
      })
    });
    
    // åˆ›å»ºAIæ¶ˆæ¯å®¹å™¨
    const aiDiv = document.createElement('div');
    aiDiv.className = 'message ai';
    aiDiv.innerHTML = '<div class="message-label">âš› Field</div><span class="content"></span><div class="stage-timeline"></div>';
    document.getElementById('chat-container').appendChild(aiDiv);
    
    const contentSpan = aiDiv.querySelector('.content');
    const reader = res.body.getReader();
    const decoder = new TextDecoder();
    
    let buffer = '';
    let fullText = '';
    let shownStages = new Set();
    
    // è¯»å–æµ
    while (true) {
      const { done, value } = await reader.read();
      if (done) break;
      
      buffer += decoder.decode(value, { stream: true });
      
      // ========== å…³é”®ä¿®å¤ï¼šæ”¹è¿›çš„é˜¶æ®µè§£æ ==========
      const stagePattern = /\|STAGE\|([^|]+)\|/g;
      let match;
      
      while ((match = stagePattern.exec(buffer)) !== null) {
        const fullMatch = match[0];
        const stageName = match[1];
        
        // æŸ¥æ‰¾å®Œæ•´é˜¶æ®µå—
        const startIdx = match.index;
        let endIdx = buffer.indexOf('\n', startIdx);
        if (endIdx < 0) endIdx = buffer.length;
        
        const stageBlock = buffer.substring(startIdx, endIdx);
        
        if (!shownStages.has(stageName)) {
          shownStages.add(stageName);
          
          // æå–æŠ€èƒ½åˆ—è¡¨
          let skills = [];
          const skillsMatch = stageBlock.match(/\|skills\|([^|]+)\|/);
          if (skillsMatch && skillsMatch[1] !== 'none' && skillsMatch[1] !== 'processing') {
            skills = skillsMatch[1].split(',').filter(s => s && s !== 'processing');
          }
          
          // æå–å·¥å…·æ•°é‡
          const toolsMatch = stageBlock.match(/(\d+)\s*tools/i);
          const toolsCount = toolsMatch ? toolsMatch[1] : null;
          
          // æå–æ¨¡å¼
          const modeMatch = stageBlock.match(/\|mode\|([^|]+)\|/);
          const mode = modeMatch ? modeMatch[1] : null;
          
          // è§¦å‘æ”¹è¿›çš„é˜¶æ®µåŠ¨ç”»
          addStageEnhanced(stageName, skills, { tools: toolsCount, mode: mode });
        }
      }
      
      // ========== å…³é”®ä¿®å¤ï¼šæ›´å®Œå–„çš„å†…å®¹æ¸…ç† ==========
      let cleanContent = buffer
        // ç§»é™¤æ‰€æœ‰ç®¡é“ç¬¦æ ‡è®°åŠå…¶å‚æ•°
        .replace(/\|[^|]+\|/g, ' ')
        // ç§»é™¤æ®‹ç•™çš„å…³é”®è¯
        .replace(/\b(complete|processing|none|skills|mode|field_density|entropy)\b/gi, '')
        // ç§»é™¤å·¥å…·æ•°é‡
        .replace(/\d+\s*tools/gi, '')
        // ç§»é™¤æ•°å€¼å‚æ•°
        .replace(/\d+\.?\d*/g, '')
        // è§„èŒƒåŒ–ç©ºç™½
        .replace(/\s+/g, ' ')
        .trim();
      
      if (cleanContent && cleanContent.length > 0) {
        fullText += cleanContent;
        contentSpan.innerHTML = formatContent(fullText);
        document.getElementById('chat-container').scrollTop = document.getElementById('chat-container').scrollHeight;
        
        // æ¸…ç©ºbufferä¸­å·²æ˜¾ç¤ºçš„å†…å®¹
        buffer = '';
      }
    }
    
    // å®Œæˆå¤„ç†
    setTimeout(() => {
      setStatus('ready', 'å°±ç»ª');
      aiDiv.querySelector('.message-label').innerHTML = 'âš› Field <span style="opacity:0.5;font-size:10px;">Â· å®Œæˆ</span>';
      
      // æ·»åŠ å®Œæˆæ ‡è®°
      const timeline = aiDiv.querySelector('.stage-timeline');
      if (timeline && shownStages.has('collapse')) {
        const completeItem = document.createElement('div');
        completeItem.className = 'stage-item';
        completeItem.style.cssText = 'margin-top:8px;color:var(--accent);font-size:11px;opacity:0.7;';
        completeItem.innerHTML = 'âœ“ åç¼©å®Œæˆ';
        timeline.appendChild(completeItem);
      }
    }, 500);
    
  } catch(e) {
    addMessage('ai', 'âŒ é”™è¯¯: ' + e.message);
    setStatus('ready', 'å°±ç»ª');
  }
  
  isSending = false;
  btn.disabled = false;
}

// æ–°å¯¹è¯
function newChat() {
  curSession = null;
  document.getElementById('chat-container').innerHTML = `
    <div class="message ai">
      <div class="message-label">âš› Quantum Field</div>
      æ–°å¯¹è¯å·²å¼€å¯ã€‚
    </div>
  `;
  toggleSidebar();
}

// é¢†åŸŸåˆ‡æ¢
document.querySelectorAll('.domain-btn').forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll('.domain-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    curDomain = btn.dataset.domain || null;
    addMessage('ai', curDomain ? 'âš› å·²åˆ‡æ¢è‡³ ' + curDomain + ' é«˜å¯†åº¦åœº' : 'âš› è¿”å›é€šç”¨åœº');
  };
});

// å›è½¦å‘é€
document.getElementById('msg-input').onkeypress = e => {
  if (e.key === 'Enter') sendMessage();
};

// åˆå§‹åŒ–
initTheme();
loadSkills();
</script>
</body>
</html>
